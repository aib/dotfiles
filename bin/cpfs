#!/bin/bash

SYSDIRS=("bin" "boot" "etc" "home" "lib" "opt" "root" "sbin" "srv" "usr" "var")
EMPTY_DIRS=("dev" "media" "mnt" "proc" "run" "sys" "tmp")

if [ -z "$1" ] || [ -z "$2" ]; then
	printf "Usage:\n\tcpfs <src> <dest> [rsync_filter_file] [rsync_options...]\n\n" >&2
	exit 1
fi

src="$1"
dest="$2"
shift
shift

if [ ! -z "$1" ] && [ -e "$1" ]; then
	filter_file_rule=("-f" "merge ""$1")
	shift
else
	filter_file_rule=()
fi

includes=()
excludes=()

for dir in "${SYSDIRS[@]}"; do
	includes+=("--include" "/""$dir" "--include" "/""$dir""/**")
done

for dir in "${EMPTY_DIRS[@]}"; do
	includes+=("--include" "/""$dir")
	excludes+=("--exclude" "/""$dir""/**")
done

rsync -a "${filter_file_rule[@]}" -F -F --delete --delete-excluded "${includes[@]}" "${excludes[@]}" --exclude "**" "$src" "$dest" "$@"
